<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Test for sites.html</title>
    <link rel="stylesheet" href="https://unpkg.com/qunit@2.20.0/qunit/qunit.css">
</head>
<body>
    <div id="qunit"></div>
    <div id="qunit-fixture"></div>

    <script src="https://unpkg.com/qunit@2.20.0/qunit/qunit.js"></script>

    <!-- Mock the DOM elements required by the script -->
    <div style="display: none;">
        <select id="site-selector"></select>
        <div id="selected-count"></div>
        <input id="search-filter" />
        <div id="sites-table-body"></div>
        <div id="loader"></div>
        <button id="scrollTopBtn"></button>
        <table>
            <thead>
                <tr>
                    <th data-sort-by="name">Name</th>
                    <th data-sort-by="country">Country</th>
                    <th data-sort-by="coordinates">Coordinates</th>
                </tr>
            </thead>
        </table>
    </div>

    <script src="../VX/parser.js"></script>
    <script src="../VX/sites.html"></script>

    <script>
        QUnit.module('Sorting Logic', function(hooks) {
            // Mock the fetch function
            hooks.beforeEach(function() {
                this.originalFetch = window.fetch;
                window.fetch = async (url) => {
                    if (url === 'output.json') {
                        return {
                            json: async () => [
                                { "id": 1, "site": "Site A", "country": "Country X", "lat": "34.0", "lng": "9.0" },
                                { "id": 2, "site": "Site B", "country": "Country Y", "lat": "32.0", "lng": "10.0" },
                                { "id": 3, "site": "Site C", "country": "Country Z", "lat": "34.0", "lng": "8.0" }
                            ]
                        };
                    }
                    return this.originalFetch(url);
                };
            });

            hooks.afterEach(function() {
                window.fetch = this.originalFetch;
            });

            QUnit.test('should sort coordinates by latitude then longitude', function(assert) {
                const done = assert.async();

                // This will trigger the fetch and initial sort
                document.addEventListener('DOMContentLoaded', () => {
                    setTimeout(() => {
                        // At this point, the data should be fetched and sorted by name ascending
                        // Now, we simulate a click to sort by coordinates
                        const coordinatesHeader = document.querySelector('th[data-sort-by="coordinates"]');

                        // First click: Ascending order
                        coordinatesHeader.click();

                        setTimeout(() => {
                            let textContent = document.getElementById('sites-table-body').textContent;

                            // Expected order: Site B (32.0), Site C (34.0, 8.0), Site A (34.0, 9.0)
                            assert.ok(textContent.indexOf('Site B') < textContent.indexOf('Site C'), 'Ascending Sort: Site B should come before Site C');
                            assert.ok(textContent.indexOf('Site C') < textContent.indexOf('Site A'), 'Ascending Sort: Site C should come before Site A');

                            // Second click: Descending order
                            coordinatesHeader.click();

                            setTimeout(() => {
                                textContent = document.getElementById('sites-table-body').textContent;

                                // Expected order: Site A (34.0, 9.0), Site C (34.0, 8.0), Site B (32.0)
                                assert.ok(textContent.indexOf('Site A') < textContent.indexOf('Site C'), 'Descending Sort: Site A should come before Site C');
                                assert.ok(textContent.indexOf('Site C') < textContent.indexOf('Site B'), 'Descending Sort: Site C should come before Site B');

                                done();
                            }, 500);
                        }, 500);
                    }, 500);
                });

                // Manually dispatch the event since the script is loaded dynamically
                window.dispatchEvent(new Event('DOMContentLoaded'));
            });
        });
    </script>
</body>
</html>
