<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RQpedia â€” Moroccan Archaeological Sites (Map)</title>

  <!-- Roboto font -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    :root{
      --gm-blue: #4285F4;
      --surface: #ffffff;
      --muted: #5f6368;
      --text: #202124;
      --card-shadow: 0 6px 18px rgba(32,33,36,0.12);
      --glass: rgba(255,255,255,0.95);
      --overlay: rgba(0,0,0,0.35);
      --radius: 12px;
      --ease: cubic-bezier(.2,.9,.2,1);
    }

    html,body{height:100%;margin:0;font-family:Roboto,system-ui,Segoe UI,Arial,sans-serif;color:var(--text);-webkit-font-smoothing:antialiased}
    /* header (title) */
    header.site-header {
      position: relative;
      z-index: 1200;
      background: linear-gradient(180deg, rgba(255,255,255,0.0), rgba(255,255,255,0.0));
      padding: 12px 16px;
      text-align: center;
      pointer-events: none;
    }
    header.site-header h1 {
      margin: 0;
      font-size: 16px;
      font-weight: 500;
      color: var(--text);
      background: rgba(255,255,255,0.8);
      display: inline-block;
      padding: 6px 12px;
      border-radius: 10px;
      box-shadow: var(--card-shadow);
      pointer-events: auto;
    }

    /* full-screen map container */
    #map-root { position: absolute; inset: 0; display:flex; flex-direction:column; }

    /* floating search bar â€” anchored on map (top-center) */
    .map-controls {
      position: absolute;
      top: 18px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1201;
      width: min(760px, calc(100% - 32px));
      pointer-events: none;
      display: flex;
      justify-content: center;
    }

    .search-card {
      pointer-events: auto;
      width: 100%;
      max-width: 720px;
      background: var(--glass);
      border-radius: 28px;
      padding: 8px 12px;
      box-shadow: var(--card-shadow);
      display:flex;
      gap:10px;
      align-items: center;
      transition: transform .18s var(--ease), box-shadow .18s var(--ease);
    }
    .search-card:focus-within { transform: translateY(-4px); box-shadow: 0 12px 36px rgba(32,33,36,0.18); }

    .search-input {
      flex:1;
      border: none;
      outline: none;
      background: transparent;
      font-size: 15px;
      padding: 8px 6px;
      color: var(--text);
      font-weight: 400;
    }
    .search-left {
      display:flex; align-items:center; gap:10px;
    }
    .search-icon {
      width:34px;height:34px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:transparent;
      color:var(--muted); font-size:16px;
    }
    .search-clear {
      width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:transparent;border:none;color:var(--muted);cursor:pointer;
    }

    /* autocomplete dropdown */
    .autocomplete-list {
      position: absolute;
      top: calc(18px + 56px);
      left: 50%;
      transform: translateX(-50%);
      z-index: 1300;
      width: min(720px, calc(100% - 64px));
      max-width: 720px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(32,33,36,0.12);
      overflow: hidden;
      display:none;
      max-height: 320px;
      overflow-y:auto;
    }
    .autocomplete-item {
      padding: 10px 14px;
      cursor: pointer;
      font-size: 14px;
      color: var(--text);
    }
    .autocomplete-item:hover, .autocomplete-item:focus {
      background: #f1f3f4;
      color: var(--text);
    }
    .autocomplete-sub {
      display:block;font-size:12px;color:var(--muted);margin-top:6px;
    }

    /* map full area */
    #map { height: 100%; width: 100%; }

    /* overlay (frosted dim) */
    .dim-overlay {
      position: absolute;
      inset: 0;
      background: var(--overlay);
      z-index: 1250;
      opacity: 0;
      pointer-events: none;
      transition: opacity .22s var(--ease);
      backdrop-filter: blur(6px);
    }
    .dim-overlay.visible { opacity: 1; pointer-events: auto; }

    /* Info Panel (desktop side, mobile bottom) */
    #info-panel {
      position: absolute;
      z-index: 1260;
      background: var(--surface);
      color: var(--text);
      box-shadow: 0 16px 40px rgba(0,0,0,0.18);
      border-radius: 12px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      transition: transform .28s var(--ease), opacity .2s var(--ease);
    }

    /* Desktop: right side panel */
    @media (min-width: 769px) {
      #info-panel { right: 18px; top: 18px; width: 360px; height: calc(100% - 36px); transform: translateX(20px); opacity:0; }
      #info-panel.open { transform: translateX(0); opacity:1; }
      #info-panel.hidden { transform: translateX(110%); opacity:0; }

      /* toggle button folded at the left edge of panel */
      #peek {
        position: absolute; left: -40px; top: 18px;
        width: 36px; height: 36px; border-radius: 8px; background:var(--surface); color:var(--gm-blue); border:1px solid #e6e6e6;
        display:flex;align-items:center;justify-content:center;box-shadow:0 6px 18px rgba(0,0,0,0.08);cursor:pointer;
      }
    }

    /* Mobile: bottom sheet */
    @media (max-width: 768px) {
      #info-panel {
        left: 0; right: 0; bottom: 0; height: 44vh; width: 100%;
        border-radius: 12px 12px 0 0; transform: translateY(110%); opacity:0;
      }
      #info-panel.open { transform: translateY(0); opacity:1; }
      #info-panel.hidden { transform: translateY(110%); opacity:0; }

      #peek {
        position: absolute; left:50%; transform:translateX(-50%); top: -28px;
        width: 120px; height: 28px; border-radius: 8px; background:#fff; color:var(--muted);
        display:flex;align-items:center;justify-content:center;box-shadow:0 6px 18px rgba(0,0,0,0.08); cursor:pointer;
      }
      #peek .grab { width: 36px; height: 4px; border-radius: 4px; background: #e0e0e0; }
      #peek .mini-summary { margin-left: 8px; font-size: 13px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:60%; }
    }

    /* info content */
    .info-header { padding: 18px 18px 12px 18px; border-bottom: 1px solid #f1f3f4; display:flex;flex-direction:column; gap:8px; background: #fff;}
    .info-title { margin:0; font-weight:500; font-size:18px; color:var(--text); }
    .info-sub { font-size:13px; color:var(--muted); margin:0; }
    .info-body { padding: 12px 18px; overflow:auto; flex:1; background: #fff; }
    .meta-row { display:flex; justify-content:space-between; gap:10px; margin-bottom:8px; font-size:13px; color:var(--muted); }
    .meta-label { color:#6b6b6b; font-weight:500; }
    .copy-btn {
      display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius: 8px; border:none; cursor:pointer;
      background: var(--gm-blue); color: #fff; font-weight:500; box-shadow: 0 6px 20px rgba(66,133,244,0.18);
    }

    /* marker animation styles for custom divIcon */
    .site-marker {
      width:26px; height:26px; border-radius:50%; background:var(--gm-blue); display:flex;align-items:center;justify-content:center;color:#fff;
      box-shadow: 0 8px 22px rgba(66,133,244,0.28);
      transform-origin: center bottom;
      opacity:0; transform: translateY(-6px) scale(0.9);
      transition: transform .4s cubic-bezier(.22,.9,.2,1), opacity .22s linear;
    }
    .site-marker.pop-in {
      opacity:1; transform: translateY(-18px) scale(1.08);
      animation: bounce .6s var(--ease) both;
    }
    @keyframes bounce {
      0% { transform: translateY(-6px) scale(0.95); }
      40% { transform: translateY(-22px) scale(1.12); }
      70% { transform: translateY(-14px) scale(0.98); }
      100% { transform: translateY(-18px) scale(1); }
    }

    /* small popup card style (when marker clicked we show panel instead, but small popup used briefly) */
    .leaflet-popup-content-wrapper {
      border-radius: 12px; box-shadow: 0 8px 26px rgba(32,33,36,0.12);
      font-family: Roboto, Arial, sans-serif;
    }
    .leaflet-popup-content { margin: 10px; font-size: 14px; color:var(--text); }

    /* tiny responsiveness helpers */
    .muted-small { color:var(--muted); font-size:13px; }
  </style>
</head>
<body>
  <!-- Title (above map) -->
  <header class="site-header" role="banner">
    <h1>RQpedia â€” Moroccan Archaeological Sites</h1>
  </header>

  <div id="map-root" role="main">
    <div id="map"></div>

    <!-- floating search inside the map -->
    <div class="map-controls" aria-hidden="false">
      <div class="search-card" role="search" aria-label="Search archaeological site">
        <div class="search-left">
          <div class="search-icon" aria-hidden="true">ðŸ”Ž</div>
        </div>
        <input id="search-input" class="search-input" type="search" placeholder="Search a Moroccan site (e.g., Taforalt, Rhafas)" autocomplete="off" aria-autocomplete="list" aria-controls="autocomplete-listbox" />
        <button id="clear-btn" class="search-clear" title="Clear search" aria-label="Clear search" hidden>âœ•</button>
      </div>
    </div>

    <!-- autocomplete dropdown -->
    <div id="autocomplete-list" class="autocomplete-list" role="listbox" aria-label="Search suggestions"></div>

    <!-- dim overlay -->
    <div id="overlay" class="dim-overlay" tabindex="-1" aria-hidden="true"></div>

    <!-- info panel -->
    <aside id="info-panel" class="hidden" aria-hidden="true" aria-labelledby="info-title" role="dialog">
      <div id="peek" aria-hidden="false" title="Open site details">
        <!-- contents altered by JS depending on screen size -->
        <span class="grab" aria-hidden="true"></span>
        <span class="mini-summary" style="display:none"></span>
      </div>

      <div class="info-header" id="info-top">
        <h2 class="info-title" id="info-title">Site name</h2>
        <p class="info-sub muted-small" id="info-sub">Coordinates Â· Periods</p>
      </div>

      <div class="info-body" id="info-body" tabindex="0">
        <!-- dynamically generated metadata rows -->
      </div>

      <div style="padding:14px; border-top:1px solid #f1f3f4; background:#fff; display:flex; gap:12px; align-items:center;">
        <button id="copy-coords" class="copy-btn" aria-label="Copy coordinates">Copy coordinates</button>
        <div style="flex:1"></div>
        <button id="close-panel" style="background:transparent;border:none;color:var(--muted);cursor:pointer;">Close</button>
      </div>
    </aside>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
  (function(){
    // Config
    const GEOJSON_FILE = 'output_full.geojson'; // must be in same folder
    const MAX_SUGGESTIONS = 12;
    const STORAGE_KEY = 'rq_infoPanelHidden';

    // Map init (Esri Satellite)
    const map = L.map('map', { zoomControl: true }).setView([31.8, -6.0], 6);
    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: 'Tiles &copy; Esri'
    }).addTo(map);

    // UI elements
    const searchInput = document.getElementById('search-input');
    const clearBtn = document.getElementById('clear-btn');
    const autoList = document.getElementById('autocomplete-list');
    const overlay = document.getElementById('overlay');
    const infoPanel = document.getElementById('info-panel');
    const peek = document.getElementById('peek');
    const infoTitle = document.getElementById('info-title');
    const infoSub = document.getElementById('info-sub');
    const infoBody = document.getElementById('info-body');
    const copyBtn = document.getElementById('copy-coords');
    const closeBtn = document.getElementById('close-panel');

    let geoFeatures = []; // { name, lat, lng, properties }
    let currentMarker = null;
    let currentSite = null;

    // Utility: safe text
    function esc(str){ return str == null ? '' : String(str); }

    // Load geojson
    async function loadGeoJSON(){
      try {
        const res = await fetch(GEOJSON_FILE);
        if(!res.ok) throw new Error('Failed to fetch ' + GEOJSON_FILE);
        const gj = await res.json();
        if(!Array.isArray(gj.features)) throw new Error('Not a FeatureCollection');
        geoFeatures = gj.features
          .map(f => {
            const coords = (f.geometry && f.geometry.coordinates) || [];
            const lng = parseFloat(coords[0]);
            const lat = parseFloat(coords[1]);
            return {
              name: (f.properties && (f.properties.site || f.properties.name)) || '',
              lat: isNaN(lat) ? null : lat,
              lng: isNaN(lng) ? null : lng,
              props: f.properties || {},
              raw: f
            };
          })
          .filter(s => s.name && s.lat !== null && s.lng !== null);
      } catch (err) {
        console.error(err);
        alert('Could not load site data: ' + err.message);
      }
    }

    // Create marker with custom divIcon to animate
    function createMarker(lat, lng) {
      const el = document.createElement('div');
      el.className = 'site-marker';
      el.innerHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" aria-hidden="true"><circle cx="12" cy="10" r="5" fill="white"/></svg>';
      const icon = L.divIcon({ className: '', html: el, iconSize: [26,26], iconAnchor: [13,26] });
      const m = L.marker([lat,lng], { icon });
      // pop-in animation after adding
      m.on('add', () => {
        // find DOM element and trigger animation
        setTimeout(() => {
          const node = m.getElement();
          if(node) {
            const inner = node.querySelector('.site-marker');
            if(inner){ inner.classList.add('pop-in'); }
          }
        }, 20);
      });
      return m;
    }

    // Present suggestions
    function showSuggestions(q) {
      autoList.innerHTML = '';
      if(!q || !q.trim()) { autoList.style.display = 'none'; return; }
      const s = q.trim().toLowerCase();
      const matches = geoFeatures.filter(f => f.name.toLowerCase().includes(s)).slice(0, MAX_SUGGESTIONS);
      if(matches.length === 0){ autoList.style.display = 'none'; return; }
      matches.forEach((m, i) => {
        const item = document.createElement('div');
        item.className = 'autocomplete-item';
        item.tabIndex = 0;
        item.setAttribute('role','option');
        item.innerHTML = `<strong>${esc(m.name)}</strong><span class="autocomplete-sub">${esc(m.props.periods && m.props.periods.join ? m.props.periods.join(', ') : '')}</span>`;
        item.addEventListener('click', () => selectSite(m));
        item.addEventListener('keydown', (e) => {
          if(e.key === 'Enter') selectSite(m);
        });
        autoList.appendChild(item);
      });
      autoList.style.display = 'block';
    }

    function clearSuggestions(){
      autoList.innerHTML = '';
      autoList.style.display = 'none';
    }

    // Select a site: center map, add marker, show panel
    function selectSite(site) {
      clearSuggestions();
      searchInput.value = site.name;
      clearBtn.hidden = false;

      if(currentMarker) map.removeLayer(currentMarker);
      currentMarker = createMarker(site.lat, site.lng).addTo(map);
      // open a small popup briefly (styled), but primary UI is panel
      currentMarker.bindPopup(`<div style="font-weight:600">${esc(site.name)}</div>`).openPopup();
      map.setView([site.lat, site.lng], 10, { animate:true });

      showInfoPanel(site);
    }

    // Build info panel content
    function showInfoPanel(site){
      currentSite = site;
      // panel open behavior depends on screen size
      const isMobile = window.innerWidth <= 768;

      // fill header & body
      infoTitle.textContent = site.name;
      const coordsText = `${site.lat.toFixed(5)}, ${site.lng.toFixed(5)}`;
      const periods = site.props.periods && site.props.periods.length ? site.props.periods.join(', ') : '';
      infoSub.textContent = `${coordsText}${periods ? ' Â· ' + periods : ''}`;

      // body content: show a prioritized set of properties
      const keysPriority = ['labnr','bp','std','cal_bp','material','species','feature','feature_type','site_type','typochronological_units','ecochronological_units','references','source_database','lab_name'];
      const bodyParts = [];

      // helper to render arrays nicely
      function valueToStr(v){
        if(v == null || v === '') return '';
        if(Array.isArray(v)) return v.join(', ');
        if(typeof v === 'object') return JSON.stringify(v);
        return String(v);
      }

      // Show prioritized keys first if available
      keysPriority.forEach(k => {
        if(site.props[k] != null && site.props[k] !== '' && !(Array.isArray(site.props[k]) && site.props[k].length === 0)){
          const label = k.replace(/_/g,' ').replace(/\b\w/g, c=>c.toUpperCase());
          const val = valueToStr(site.props[k]);
          bodyParts.push(`<div class="meta-row"><div class="meta-label">${esc(label)}</div><div>${esc(val)}</div></div>`);
        }
      });
      // then show rest of props (except site)
      for(const [k,v] of Object.entries(site.props)){
        if(k==='site') continue;
        if(keysPriority.includes(k)) continue;
        if(v == null || v === '' || (Array.isArray(v) && v.length===0)) continue;
        const label = k.replace(/_/g,' ').replace(/\b\w/g, c=>c.toUpperCase());
        bodyParts.push(`<div class="meta-row"><div class="meta-label">${esc(label)}</div><div>${esc(valueToStr(v))}</div></div>`);
      }

      // insert coords at bottom
      bodyParts.push(`<div class="meta-row"><div class="meta-label">Latitude</div><div>${site.lat.toFixed(6)}</div></div>`);
      bodyParts.push(`<div class="meta-row"><div class="meta-label">Longitude</div><div>${site.lng.toFixed(6)}</div></div>`);

      infoBody.innerHTML = bodyParts.join('');

      // peek handle mini summary (mobile)
      const mini = peek.querySelector('.mini-summary');
      if(mini){
        mini.style.display = window.innerWidth <= 768 ? 'inline-block' : 'none';
        mini.textContent = `${site.name} Â· ${coordsText}`;
      }

      // open panel + overlay
      openPanel();
    }

    function openPanel(){
      infoPanel.classList.add('open');
      infoPanel.classList.remove('hidden');
      overlay.classList.add('visible');
      infoPanel.setAttribute('aria-hidden','false');
      overlay.setAttribute('aria-hidden','false');
      // persist
      localStorage.setItem(STORAGE_KEY, 'false');
    }

    function closePanel(){
      infoPanel.classList.remove('open');
      // keep hidden class for consistent transform target
      infoPanel.classList.add('hidden');
      overlay.classList.remove('visible');
      infoPanel.setAttribute('aria-hidden','true');
      overlay.setAttribute('aria-hidden','true');
      // persist
      localStorage.setItem(STORAGE_KEY, 'true');
    }

    // toggle (peek)
    function togglePanel(){
      if(infoPanel.classList.contains('open')){
        closePanel();
      } else {
        openPanel();
      }
    }

    // Copy coordinates
    copyBtn.addEventListener('click', async () => {
      if(!currentSite) return;
      const txt = `${currentSite.lat.toFixed(6)}, ${currentSite.lng.toFixed(6)}`;
      try {
        await navigator.clipboard.writeText(txt);
        copyBtn.textContent = 'Copied âœ“';
        setTimeout(()=> copyBtn.textContent = 'Copy coordinates', 1400);
      } catch (err) {
        alert('Copy failed');
      }
    });

    // Close buttons & overlay handlers
    closeBtn.addEventListener('click', closePanel);
    overlay.addEventListener('click', closePanel);

    // Peek / toggle click
    peek.addEventListener('click', () => {
      togglePanel();
    });

    // Clear search
    clearBtn.addEventListener('click', () => { searchInput.value = ''; clearBtn.hidden = true; clearSuggestions(); searchInput.focus(); });

    // Keyboard handlers for accessibility
    searchInput.addEventListener('keydown', (e) => {
      if(e.key === 'Escape'){ searchInput.value = ''; clearSuggestions(); }
      if(e.key === 'Enter'){ // try to pick exact match or first partial
        const q = searchInput.value.trim().toLowerCase();
        if(!q) return;
        const exact = geoFeatures.find(s => s.name.toLowerCase() === q);
        if(exact) selectSite(exact);
        else {
          const partial = geoFeatures.find(s => s.name.toLowerCase().includes(q));
          if(partial) selectSite(partial);
        }
      }
    });

    // Input -> suggestions
    let inputTimer = null;
    searchInput.addEventListener('input', (e) => {
      const v = e.target.value;
      clearTimeout(inputTimer);
      inputTimer = setTimeout(()=> {
        if(v && v.trim().length > 0) {
          showSuggestions(v);
          clearBtn.hidden = false;
        } else {
          clearSuggestions();
          clearBtn.hidden = true;
        }
      }, 120);
    });

    // Click outside to close autocomplete
    document.addEventListener('click', (e) => {
      if(!e.target.closest('.search-card') && !e.target.closest('.autocomplete-list')){
        clearSuggestions();
      }
    });

    // Panel swipe gestures for mobile (touch)
    (function addSwipe(){
      let startY = 0, currentY = 0, dragging = false;
      const panel = infoPanel;

      panel.addEventListener('touchstart', (ev) => {
        if(window.innerWidth > 768) return;
        startY = ev.touches[0].clientY;
        dragging = true;
        panel.style.transition = 'none';
      }, { passive: true });

      panel.addEventListener('touchmove', (ev) => {
        if(!dragging) return;
        currentY = ev.touches[0].clientY;
        const dy = currentY - startY;
        if(dy > 0){ // dragging down
          panel.style.transform = `translateY(${dy}px)`;
        } else {
          // small upward move allowed
          panel.style.transform = `translateY(${dy}px)`;
        }
      }, { passive: true });

      panel.addEventListener('touchend', (ev) => {
        if(!dragging) return;
        dragging = false;
        panel.style.transition = '';
        const dy = currentY - startY;
        if(dy > 80){ // swipe down to close
          closePanel();
        } else {
          // reopen / reset
          panel.style.transform = '';
          openPanel();
        }
        // reset
        startY = currentY = 0;
      });
    })();

    // Remember panel state on load
    function restorePanelState(){
      const saved = localStorage.getItem(STORAGE_KEY);
      if(saved === 'true'){ // hidden
        infoPanel.classList.add('hidden');
        infoPanel.classList.remove('open');
        overlay.classList.remove('visible');
        infoPanel.setAttribute('aria-hidden','true');
      } else {
        // keep closed by default, but not forced open
        infoPanel.classList.remove('open');
        infoPanel.classList.add('hidden');
        overlay.classList.remove('visible');
      }
    }

    // Responsive: hide peek mini summary on desktop
    function updatePeekUI(){
      const mini = peek.querySelector('.mini-summary');
      if(!mini) return;
      if(window.innerWidth <= 768) {
        mini.style.display = currentSite ? 'inline-block' : 'none';
      } else {
        mini.style.display = 'none';
      }
    }

    // Initialize
    (async function init(){
      await loadGeoJSON();
      restorePanelState();
      updatePeekUI();
      window.addEventListener('resize', () => { updatePeekUI(); });

      // center map to bounding box of features for nicer initial view if loaded
      if(geoFeatures.length){
        const group = geoFeatures.map(f => [f.lat,f.lng]);
        try {
          map.fitBounds(group, { padding:[40,40], maxZoom:7 });
        } catch(e){}
      }
    })();

    // Expose for debugging (optional)
    window.__RQ = { map, geoFeatures, selectSite };
  })();
  </script>
</body>
</html>
