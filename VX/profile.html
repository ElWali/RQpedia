<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Site Profile — RQpedia</title>
    <link rel="stylesheet" href="theme.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==" crossorigin="" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" />
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>
    <header>
        <div class="logo">
            <a href="index.html">RQpedia</a>
        </div>
        <nav class="nav-links">
            <a href="sites.html">Browse data</a>
            <a href="about.html">About</a>
            <a href="contribute.html">Contribute</a>
        </nav>
        <div class="header-actions">
            <button class="small-btn">Download all JSON</button>
        </div>
    </header>

    <main class="container">
        <aside class="panel">
            <div class="info-card">
                <div class="site-header">
                    <h1 id="site-name">Loading…</h1>
                    <p class="site-type">Archaeological site in <span id="site-country-subheader"></span></p>
                    <div class="site-meta">
                        Record created in XRONOS on <span id="created-date"></span>. Last updated on <span id="updated-date"></span>.
                        <a href="#changelog">See changelog for details.</a>
                    </div>
                </div>
            </div>

            <!-- Location -->
            <div class="info-card">
                <h2 class="info-card-header">Location</h2>
                <table>
                    <tr>
                        <th>Coordinates (degrees)</th>
                        <td id="coords-deg" data-label="Coordinates (degrees)"></td>
                    </tr>
                    <tr>
                        <th>Coordinates (DMS)</th>
                        <td id="coords-dms" data-label="Coordinates (DMS)"></td>
                    </tr>
                    <tr>
                        <th>Country</th>
                        <td id="country" data-label="Country"></td>
                    </tr>
                </table>
            </div>

            <!-- Map -->
            <div id="map"></div>
        </aside>

        <section>
            <!-- Radiocarbon Dates -->
            <div class="info-card">
                <h2 class="info-card-header">Radiocarbon Dates</h2>
                <table id="c14-table" class="table">
                    <thead>
                        <tr>
                            <th>Lab ID</th>
                            <th>Context</th>
                            <th>Material</th>
                            <th>Taxon</th>
                            <th>Method</th>
                            <th>Uncalibrated age</th>
                            <th>Calibrated age</th>
                            <th>References</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Populated by script -->
                    </tbody>
                </table>
            </div>

            <!-- Typological Dates -->
            <div class="info-card">
                <h2 class="info-card-header">Typological Dates</h2>
                <table id="typo-table" class="table">
                    <thead>
                        <tr>
                            <th>Classification</th>
                            <th>Estimated age</th>
                            <th>References</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Populated by script -->
                    </tbody>
                </table>
            </div>

            <!-- Bibliographic References -->
            <div class="info-card">
                <h2 class="info-card-header">Bibliographic References</h2>
                <div id="references-container" style="padding: 16px 20px;" aria-live="polite"></div>
            </div>

            <!-- Changelog / Open Data -->
            <div class="info-card" id="changelog">
                <h2 class="info-card-header">Open data related to the archaeological site</h2>
                <div style="padding: 16px 20px;">
                    <p>
                        Display open data related to the archaeological site fetched automatically from Wikimedia Commons, Wikidata and other open data sources (images, videos, …)
                    </p>
                    <div id="changelog-container" aria-live="polite"></div>
                </div>
            </div>

            <!-- Linked Open Data – moved to bottom -->
            <div class="info-card">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 16px; padding: 16px 20px;">
                    <h2 class="info-card-header">Linked Open Data</h2>
                    <button id="report-link-btn" class="small-btn">
                        <i class="bi bi-link-45deg"></i> Report missing link
                    </button>
                </div>
                <div id="linked-data-content" style="padding: 0 20px 16px;" aria-live="polite">
                    <p style="color: var(--muted);">Loading linked open data from Wikidata and DBpedia…</p>
                </div>
            </div>
        </section>
    </main>

    <footer>
        <p>
            This work is licensed under a
            <a href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.
        </p>
        <p>
            <a href="https://github.com/xronos-ch/xronos.rails/">View source on GitHub</a>
        </p>
    </footer>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script type="module">
        import { parseReferences } from './parser.js';
        // === UTILITIES ===
        function cleanJsonString(str) {
          if (typeof str !== 'string') return str;
          return str
            .replace(/\\"/g, '"') // Unescape escaped quotes
            .replace(/""/g, '"') // Fix double quotes
            .replace(/"reference_":/g, '"reference":'); // Normalize keys
        }

        const escapeHtml = (str) => {
            if (typeof str !== 'string') return '';
            return str.replace(/&/g, '&amp;').replace(/</g, '<').replace(/>/g, '>').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
        };

        function safeParsePossibleJSONField(val) {
            if (!val && val !== 0) return null;
            if (Array.isArray(val) || typeof val === 'object') return val;

            if (typeof val === 'string') {
                try {
                    const cleanedVal = cleanJsonString(val);
                    return JSON.parse(cleanedVal);
                } catch (e) {
                    // Fallback for non-JSON strings or strings that are still malformed
                    return [{ "reference": val }];
                }
            }
            return null;
        }

        function formatDMS(deg, latOrLng = 'lat') {
            if (deg == null || Number.isNaN(deg)) return '—';
            const sign = deg >= 0 ? 1 : -1;
            const abs = Math.abs(deg);
            const d = Math.floor(abs);
            const mFloat = (abs - d) * 60;
            const m = Math.floor(mFloat);
            const s = ((mFloat - m) * 60).toFixed(1);
            if (latOrLng === 'lat') {
                return `${d}°${m}'${s}" ${deg >= 0 ? 'N' : 'S'}`;
            }
            return `${d}°${m}'${s}" ${deg >= 0 ? 'E' : 'W'}`;
        }

        let mapInstance = null;
        let mapMarker = null;

        function renderMap(lat, lng, siteName) {
            const mapEl = document.getElementById('map');
            if (!mapInstance) {
                mapInstance = L.map(mapEl, { zoomControl: true, attributionControl: true });
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '&copy; OpenStreetMap contributors'
                }).addTo(mapInstance);
            }
            if (mapMarker) {
                mapMarker.remove();
                mapMarker = null;
            }
            if (lat != null && lng != null) {
                mapInstance.setView([lat, lng], 9);
                mapMarker = L.marker([lat, lng]).addTo(mapInstance).bindPopup(`<strong>${escapeHtml(siteName)}</strong>`);
            } else {
                mapInstance.setView([30, 0], 3);
            }
        }

        // === RENDER PROFILE ===
        function renderProfilePage(siteData, allData) {
            const siteName = siteData.site;
            const records = allData.filter(d => (d.site || '').toLowerCase() === siteName.toLowerCase());

            // Header
            document.getElementById('site-name').textContent = siteName;
            document.getElementById('site-country-subheader').textContent = siteData.country || '—';
            document.getElementById('country').textContent = siteData.country || '—';
            const created = siteData.created_at ? new Date(siteData.created_at).toLocaleDateString() : 'N/A';
            const updated = siteData.updated_at ? new Date(siteData.updated_at).toLocaleDateString() : 'N/A';
            document.getElementById('created-date').textContent = created;
            document.getElementById('updated-date').textContent = updated;

            // Coordinates
            const lat = parseFloat(siteData.lat);
            const lng = parseFloat(siteData.lng);
            document.getElementById('coords-deg').textContent = (lat && lng) ? `${lat.toFixed(5)}, ${lng.toFixed(5)}` : '—';
            document.getElementById('coords-dms').textContent = (lat && lng) ? `${formatDMS(lat, 'lat')}, ${formatDMS(lng, 'lng')}` : '—';

            // Map
            renderMap(lat, lng, siteName);

            // Radiocarbon Table
            const c14Tbody = document.querySelector('#c14-table tbody');
            c14Tbody.innerHTML = '';
            const c14Records = records.filter(r => r.bp && r.std);
            if(c14Records.length > 0) {
                const uniqueC14Records = [];
                const seen = new Set();
                c14Records.forEach(r => {
                    const key = `${r.bp}-${r.std}`;
                    if (!seen.has(key)) {
                        uniqueC14Records.push(r);
                        seen.add(key);
                    }
                });

                uniqueC14Records.forEach(r => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td data-label="Lab ID">${escapeHtml(r.labnr || '—')}</td>
                        <td data-label="Context">${escapeHtml(r.feature_type || '—')}</td>
                        <td data-label="Material">${escapeHtml(r.material || '—')}</td>
                        <td data-label="Taxon">${escapeHtml(r.species || '—')}</td>
                        <td data-label="Method">Radiocarbon</td>
                        <td data-label="Uncalibrated age">${r.bp} ± ${r.std}</td>
                        <td data-label="Calibrated age">${escapeHtml(r.cal_bp || '—')}</td>
                        <td data-label="References">${parseReferences(r.reference || siteData.references)}</td>
                    `;
                    c14Tbody.appendChild(tr);
                });
            } else {
                c14Tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; color: var(--muted);">No radiocarbon data available.</td></tr>';
            }

            // Typological Table
            const typoTbody = document.querySelector('#typo-table tbody');
            typoTbody.innerHTML = '';
            const typoRecords = records.flatMap(r => r.periods || []);
            const uniqueTypoRecords = [...new Set(typoRecords)]; // Remove duplicates

            if(uniqueTypoRecords.length > 0) {
                uniqueTypoRecords.forEach(period => { // `period` is a string
                    const tr = document.createElement('tr');

                    const allSiteReferences = new Set();
                    records.forEach(r => {
                        if (r.periods && r.periods.includes(period) && r.references) {
                            r.references.forEach(ref => {
                                if (ref.author && ref.year) {
                                    allSiteReferences.add(`${ref.author} (${ref.year})`);
                                }
                            })
                        }
                    });
                    const refsString = [...allSiteReferences].join('; ') || '—';

                    tr.innerHTML = `
                        <td data-label="Classification">${escapeHtml(period || '—')}</td>
                        <td data-label="Estimated age">—</td>
                        <td data-label="References">${escapeHtml(refsString)}</td>
                    `;
                    typoTbody.appendChild(tr);
                });
            } else {
                typoTbody.innerHTML = '<tr><td colspan="3" style="text-align:center; color: var(--muted);">No typological data available.</td></tr>';
            }

            // References
            const refsContainer = document.getElementById('references-container');
            refsContainer.innerHTML = '';
            const allReferences = new Set();

            records.forEach(r => {
                if (r.references) {
                    const parsed = parseReferences(r.references);
                    if (parsed !== '—') {
                        // Split by semicolon to add each reference individually
                        parsed.split('; ').forEach(ref => allReferences.add(ref));
                    }
                }
            });

            if (allReferences.size > 0) {
                const refsHTML = [...allReferences].map(ref => `<p>${escapeHtml(ref)}</p>`).join('');
                refsContainer.innerHTML = refsHTML;
            } else {
                refsContainer.innerHTML = '<p style="color: var(--muted);">No bibliographic references available.</p>';
            }
        }


        // === DATA FETCHING & INITIALIZATION ===
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const siteId = decodeURIComponent(urlParams.get('id') || '').trim();

            if (!siteId) {
                document.getElementById('site-name').textContent = 'Site not specified';
                return;
            }

            fetch('output.json')
                .then(response => {
                    if (!response.ok) throw new Error('output.json not found');
                    return response.json();
                })
                .then(data => {
                    const siteData = data.find(s => s.id === siteId);

                    if (!siteData) {
                        document.getElementById('site-name').textContent = 'Site not found';
                        return;
                    }

                    renderProfilePage(siteData, data);

                })
                .catch(error => {
                    console.error('Failed to load site data:', error);
                    document.getElementById('site-name').textContent = 'Error loading site data';
                });
        });
    </script>
</body>
</html>
